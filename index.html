<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        prompt: ["Prompt", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="font-prompt">

    <!-- Chat Popup -->
    <div id="chat-popup"
        class="fixed bottom-6 right-6 w-[90vw] max-w-lg h-[75vh] bg-white rounded-xl shadow-lg flex flex-col overflow-hidden border z-50">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-3 text-center font-medium">
            <i class="fas fa-robot"></i> AI Analytic Bot
        </div>

        <!-- Chat Area -->
        <div id="chatbox" class="flex-1 p-3 overflow-y-auto space-y-3 text-sm"></div>

        <!-- Input -->
        <div class="p-3 border-t flex items-center gap-2">
            <input id="chatInput" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
                class="flex-1 border rounded-xl px-3 py-2 outline-none text-sm"
                onkeydown="if(event.key==='Enter') sendMessage()" />
            <button onclick="sendMessage()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm">‡∏™‡πà‡∏á</button>
        </div>
    </div>

    <script>
        const chatbox = document.getElementById("chatbox");
        const chatInput = document.getElementById("chatInput");

        function scrollToBottom() {
            chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });
        }

        function appendMessage(text, sender) {
            const wrapper = document.createElement("div");
            wrapper.className = `flex items-end gap-2 ${sender === "user" ? "justify-end" : ""}`;

            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs";
            avatar.innerHTML = sender === "user" ? "üë§" : '<i class="fas fa-robot"></i>';

            const bubble = document.createElement("div");
            bubble.className = `px-4 py-2 max-w-[75%] rounded-2xl text-xs whitespace-pre-wrap shadow-xl ${sender === "user"
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-800"}`;

            if (sender === "bot") {
                const raw = typeof text === "string" ? text : JSON.stringify(text);
                const fixedText = raw.replaceAll('\\n', '\n');
                bubble.innerHTML = marked.parse(fixedText);
            } else {
                bubble.textContent = text;
            }

            if (sender === "user") {
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
            } else {
                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
            }

            chatbox.appendChild(wrapper);
            scrollToBottom();
        }

        function appendTypingDots() {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-end gap-2";

            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs";
            avatar.innerHTML = '<i class="fas fa-robot"></i>';

            const bubble = document.createElement("div");
            bubble.className = "px-4 py-2 bg-gray-200 text-gray-800 max-w-[75%] rounded-2xl shadow-xl";

            const dots = document.createElement("div");
            dots.className = "flex space-x-1";

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement("div");
                dot.className = `w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce`;
                dot.style.animationDelay = `${i * 0.2}s`; // ‡πÑ‡∏•‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏à‡∏∏‡∏î
                dots.appendChild(dot);
            }

            bubble.appendChild(dots);
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            chatbox.appendChild(wrapper);
            scrollToBottom();
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[tag]));
        }

        let sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
            sessionId = crypto.randomUUID();
            localStorage.setItem("sessionId", sessionId);
        }

        async function sendMessage() {
            const safeInput = escapeHTML(chatInput.value.trim());
            if (!safeInput) return;

            appendMessage(safeInput, "user");
            chatInput.value = "";
            //appendMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...", "bot");
            appendTypingDots();

            try {
                const res = await fetch("https://c8a9-2001-fb1-af-77b2-9d12-f3a1-838f-f6d1.ngrok-free.app/webhook-test/jita-ai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId, message: safeInput })
                });

                const data = await res.json();
                chatbox.lastChild.remove(); // remove "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå..."
                appendMessage(data.output || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "bot");

            } catch (err) {
                chatbox.lastChild.remove();
                appendMessage(
                    `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô:\n‚Ä¢ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß‡πÉ‡∏ô‡∏õ‡∏µ 2023 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?\n‚Ä¢ ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß ‡πÉ‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏µ 2024?\n‚Ä¢ ‡∏Ç‡∏≠‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î 5 ‡∏õ‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô`,
                    "bot"
                );
            }
        }

        window.onload = () => {
            const welcomeMessage = `
‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‚ú®

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏â‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:
‚Ä¢ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡πÑ‡∏£ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
‚Ä¢ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
‚Ä¢ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤

‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
            appendMessage(welcomeMessage.trim(), "bot");
        };
    </script>
</body>

</html>
