<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        prompt: ["Prompt", "sans-serif"]
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    },
                    animation: {
                        wave: 'wave 0.9s infinite ease-in-out'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="font-prompt">

    <!-- Chat Popup -->
    <div id="chat-popup" class="fixed bottom-4 left-1/2 translate-x-[-50%] 
            w-[94vw] max-w-full sm:w-[90vw] sm:max-w-md md:max-w-lg lg:max-w-xl 
            h-[80vh] bg-white rounded-xl shadow-lg flex flex-col overflow-hidden border z-50">
        <!-- Header -->
        <div class="bg-blue-600 text-white text-center font-medium p-3 rounded-t-xl !p-3">
            <i class="fas fa-robot"></i> AI Analytic Bot
        </div>

        <!-- Chat Area -->
        <div id="chatbox"
            class="flex-1 p-3 overflow-y-auto space-y-3 text-sm sm:text-base md:text-[16px] lg:text-[17px]"></div>

        <!-- Input -->
        <div class="p-3 border-t flex items-center gap-2">
            <input id="chatInput" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
                class="flex-1 border rounded-xl px-3 py-2 outline-none text-sm"
                onkeydown="if(event.key==='Enter') sendMessage()" />
            <button onclick="sendMessage()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm">‡∏™‡πà‡∏á</button>
        </div>
    </div>

    <script>
        const chatbox = document.getElementById("chatbox");
        const chatInput = document.getElementById("chatInput");

        function scrollToBottom() {
            chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });
        }

        // function appendMessage(text, sender) {
        //     const wrapper = document.createElement("div");
        //     wrapper.className = `flex items-end gap-2 ${sender === "user" ? "justify-end" : ""}`;

        //     const avatar = document.createElement("div");
        //     avatar.className = "w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs";
        //     avatar.innerHTML = sender === "user" ? "üë§" : '<i class="fas fa-robot"></i>';

        //     const bubble = document.createElement("div");
        //     bubble.className = `
        //         px-4 py-2 max-w-[75%] rounded-2xl whitespace-pre-wrap shadow-xl
        //         text-sm sm:text-base md:text-[14px]
        //         ${sender === "user" ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-800"}
        //         `;

        //     if (sender === "bot") {
        //         const raw = typeof text === "string" ? text : JSON.stringify(text);
        //         const fixedText = raw.replaceAll('\\n', '\n');
        //         // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô <table> HTML ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        //         if (fixedText.trim().startsWith("<table")) {
        //             bubble.innerHTML = fixedText; // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ marked ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö table
        //         } else {
        //             bubble.innerHTML = marked.parse(fixedText); // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö markdown ‡∏õ‡∏Å‡∏ï‡∏¥
        //         }
        //     } else {
        //         bubble.textContent = text;
        //     }

        //     if (sender === "user") {
        //         wrapper.appendChild(bubble);
        //         wrapper.appendChild(avatar);
        //     } else {
        //         wrapper.appendChild(avatar);
        //         wrapper.appendChild(bubble);
        //     }

        //     chatbox.appendChild(wrapper);
        //     scrollToBottom();
        // }
        function appendMessage(text, sender) {
            const wrapper = document.createElement("div");
            wrapper.className = `flex items-end gap-2 ${sender === "user" ? "justify-end" : ""}`;

            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs";
            avatar.innerHTML = sender === "user" ? "üë§" : '<i class="fas fa-robot"></i>';

            const bubble = document.createElement("div");
            bubble.className = `
        px-4 py-2 max-w-[75%] rounded-2xl whitespace-pre-wrap shadow-xl
        text-sm sm:text-base md:text-[14px]
        ${sender === "user" ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-800"}
    `;

            const content = document.createElement("span");
            bubble.appendChild(content);

            if (sender === "user") {
                content.textContent = text;
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
                chatbox.appendChild(wrapper);
                scrollToBottom();
            } else {
                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
                chatbox.appendChild(wrapper);
                scrollToBottom();

                // ‚úÖ Typing effect
                const raw = typeof text === "string" ? text : JSON.stringify(text);
                const fixedText = raw.replaceAll('\\n', '\n');
                const html = fixedText.trim().startsWith("<table")
                    ? fixedText
                    : marked.parse(fixedText);

                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = html;
                const plainText = tempDiv.textContent || tempDiv.innerText || "";

                let index = 0;
                const interval = setInterval(() => {
                    if (index < plainText.length) {
                        content.textContent += plainText[index++];
                        scrollToBottom();
                    } else {
                        clearInterval(interval);
                        // ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á HTML markdown ‡∏à‡∏£‡∏¥‡∏á
                        if (!fixedText.trim().startsWith("<table")) {
                            bubble.innerHTML = marked.parse(fixedText);
                        } else {
                            bubble.innerHTML = fixedText;
                        }
                    }
                }, 12); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÑ‡∏î‡πâ (10 = ‡πÄ‡∏£‡πá‡∏ß, 30 = ‡∏ä‡πâ‡∏≤)
            }
        }

        function appendTypingDots() {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-end gap-2";

            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs";
            avatar.innerHTML = '<i class="fas fa-robot"></i>';

            const bubble = document.createElement("div");
            bubble.className = "px-4 pt-4 pb-2 bg-gray-200 text-gray-800 max-w-[75%] rounded-2xl shadow-xl min-h-[40px] flex items-center justify-center";

            const dots = document.createElement("div");
            dots.className = "flex space-x-1 ";

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement("div");
                dot.className = `w-2 h-2 bg-gray-600 rounded-full animate-wave`;
                dot.style.animationDelay = `${i * 0.2}s`; // ‡πÑ‡∏•‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏à‡∏∏‡∏î
                dots.appendChild(dot);
            }

            bubble.appendChild(dots);
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            chatbox.appendChild(wrapper);
            scrollToBottom();
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[tag]));
        }

        let sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
            sessionId = crypto.randomUUID();
            localStorage.setItem("sessionId", sessionId);
        }

        async function sendMessage() {
            const safeInput = escapeHTML(chatInput.value.trim());
            if (!safeInput) return;

            appendMessage(safeInput, "user");
            chatInput.value = "";
            //appendMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...", "bot");
            appendTypingDots();

            try {
                const res = await fetch("https://c6c8ef3c300b.ngrok-free.app/webhook/jita-ai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId, message: safeInput })
                });

                const data = await res.json();
                chatbox.lastChild.remove(); // remove "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå..."
                //appendMessage(data.output || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "bot");
                if (data.output) {
                    appendMessage(data.output, "bot");
                }

                if (data.htmlTable) {
                    appendMessage(data.htmlTable, "bot"); // ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á <table> ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô htmlTable ‡∏°‡∏µ <table>...</table>
                }

            } catch (err) {
                chatbox.lastChild.remove();
                appendMessage(
                    `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô:\n‚Ä¢ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß‡πÉ‡∏ô‡∏õ‡∏µ 2023 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?\n‚Ä¢ ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß ‡πÉ‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏µ 2024?\n‚Ä¢ ‡∏Ç‡∏≠‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î 5 ‡∏õ‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô`,
                    "bot"
                );
            }
        }

        window.onload = () => {
            const welcomeMessage = `
‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏™.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‚ú®

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏â‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:
‚Ä¢ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡πÑ‡∏£ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
‚Ä¢ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
‚Ä¢ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤

‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
            appendMessage(welcomeMessage.trim(), "bot");
        };
    </script>
</body>

</html>
